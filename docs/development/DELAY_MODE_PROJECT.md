# 遅延モード導入プロジェクト計画書

## 📋 エグゼクティブサマリー

本プロジェクトは、LogiCircに「真のイベント駆動シミュレーション」を導入し、実際のハードウェアに近い動作を再現可能にする大規模アップデートです。教育的価値を保ちながら、段階的に高度な機能を追加していきます。

### プロジェクト概要
- **期間**: 4-5ヶ月
- **影響範囲**: コアエンジン、UI、学習コンテンツ、ドキュメント
- **リスク**: 中〜高（段階的リリースで軽減）

## 🎯 プロジェクトゴール

### 最終目標
1. 各ゲートに固有の伝播遅延を持たせる
2. 教育用（遅延なし）と実践用（遅延あり）の両モードを提供
3. タイミング関連の問題（ハザード、レース条件）を学習可能に

### 成功基準
- DELAYゲートなしでリングオシレータが動作
- 既存ユーザーの学習体験を損なわない
- 上級ユーザーがタイミング設計を学習できる

## 🏗️ アーキテクチャ変更

### コア変更点
```typescript
// Gate型の拡張
interface Gate {
  // 既存のプロパティ...
  
  // 新規追加（Phase 0）
  timing?: {
    propagationDelay?: number;  // ns単位
    // 将来の拡張用
    riseTime?: number;
    fallTime?: number;
  };
}

// デフォルト遅延値
const DEFAULT_GATE_DELAYS: Record<GateType, number> = {
  'NOT': 1.0,    // 1ns
  'AND': 2.0,    // 2ns
  'OR': 2.0,     // 2ns
  'NAND': 1.5,   // 1.5ns
  'NOR': 1.5,    // 1.5ns
  'XOR': 3.0,    // 3ns
  'D-FF': 5.0,   // 5ns
  'SR-LATCH': 4.0, // 4ns
};
```

### エンジン統合
- `MinimalEventDrivenEngine` → `EventDrivenEngine`に統合
- 遅延計算機能を内蔵（フラグで切替）

## 📅 詳細マイルストーン

### Phase 0: 基盤準備（2週間）
**開始**: 即時  
**目標**: リスクゼロの準備作業

#### タスク
- [ ] プロジェクト計画書の承認
- [ ] 技術設計文書作成
- [ ] 型定義の拡張（Gate型）
- [ ] デフォルト遅延値の決定
- [ ] テスト戦略文書作成
- [ ] CI/CDパイプラインの準備

#### 成果物
- 本計画書
- 技術設計文書
- 拡張された型定義

---

### Phase 1: コアエンジン実装（3週間）
**開始**: Phase 0完了後  
**目標**: 内部的に遅延計算可能（UIなし）

#### Week 1: 基本実装とテスト環境
- [ ] EventDrivenEngineのリファクタリング開始
- [ ] 遅延計算の基本ロジック実装
- [ ] **3-NOTリングオシレータの単体テスト作成**
- [ ] デバッグ用コンソールツール作成

#### Week 2: オシレータ動作検証
- [ ] 3-NOTオシレータの発振確認
- [ ] 発振周期の理論値検証（6ns）
- [ ] 初期状態依存性のテスト
- [ ] 偶数NOTチェーンのテスト

#### Week 3: 安定化と最適化
- [ ] パフォーマンステスト（1000ゲート規模）
- [ ] メモリ使用量の検証
- [ ] 他の循環回路（SR-Latch等）テスト
- [ ] コードレビューと最適化

#### 成果物
- 遅延対応EventDrivenEngine
- 包括的な単体テスト
- パフォーマンスベンチマーク

#### リスクと対策
- **リスク**: オシレータが発振しない
- **対策**: Week 1で早期検証、問題があれば即修正

---

### Phase 2: 最小UI実装（2週間）
**開始**: Phase 1完了後  
**目標**: シンプルなトグルスイッチのみ

#### タスク
- [ ] ツールパレットUIコンポーネント作成
- [ ] 遅延モードON/OFFトグル実装
- [ ] localStorageでの設定永続化
- [ ] 基本的なツールチップヘルプ
- [ ] E2Eテスト作成

#### UI設計
```
┌─────────────┐
│ シミュレーション │
├─────────────┤
│ 🕐 遅延     │
│ [ OFF | ON ]│
│             │
│ OFF: 即座に変化│
│ ON: 1-3ns遅延 │
└─────────────┘
```

#### 成果物
- 動作するトグルスイッチ
- 設定の永続化
- E2Eテスト

---

### Phase 3: 視覚フィードバック（3週間）
**開始**: Phase 2の1週間後（部分並行）  
**目標**: 遅延を視覚的に理解可能に

#### Week 1: 基本表示
- [ ] ゲート近傍への遅延値表示
- [ ] 表示ON/OFFオプション
- [ ] モード切替時の警告ダイアログ

#### Week 2: アニメーション
- [ ] 信号伝播のグラデーション表現
- [ ] 遅延中の視覚的フィードバック
- [ ] パフォーマンス最適化

#### Week 3: タイミングチャート統合
- [ ] 時間軸の自動切替（サイクル/ns）
- [ ] 遅延の可視化
- [ ] ズーム機能の調整

#### 成果物
- 視覚的に分かりやすい遅延表示
- タイミングチャート対応

---

### Phase 4: モード別対応（4週間）
**開始**: Phase 3と部分並行  
**目標**: 全モードで適切に動作

#### 4-1: 学習モード対応（2週間）
- [ ] レッスンメタデータに遅延設定追加
- [ ] 基本レッスンでの強制OFF実装
- [ ] 警告メッセージの実装
- [ ] タイミング専用レッスン作成
  - [ ] 「遅延とは何か」
  - [ ] 「レース条件を理解する」
  - [ ] 「ハザードの観察」

#### 4-2: ギャラリー・その他（1週間）
- [ ] 各回路に推奨モード設定追加
- [ ] 非互換警告の実装
- [ ] リングオシレータ回路の更新（DELAY削除版）

#### 4-3: ドキュメント（1週間）
- [ ] ヘルプコンテンツ作成
- [ ] FAQ更新
- [ ] リリースノート準備
- [ ] 技術ブログ記事作成

---

### Phase 5: 高度な機能（6週間）
**開始**: Phase 4完了後  
**目標**: プロ向け機能

#### 機能リスト
- [ ] 遅延値一覧パネル
- [ ] プリセット機能（高速/標準/低速）
- [ ] 個別ゲート遅延設定
- [ ] クリティカルパス解析
- [ ] ハザード自動検出
- [ ] セットアップ/ホールド違反検出
- [ ] タイミングレポート生成

## 🎮 3-NOTリングオシレータテスト計画

### テストケース
```typescript
// 最重要テストケース
describe('Ring Oscillator without DELAY gate', () => {
  const circuit = {
    gates: [
      { id: 'NOT1', type: 'NOT', output: true },   // 初期値
      { id: 'NOT2', type: 'NOT', output: false },
      { id: 'NOT3', type: 'NOT', output: false },
    ],
    wires: [
      { from: 'NOT1', to: 'NOT2' },
      { from: 'NOT2', to: 'NOT3' },
      { from: 'NOT3', to: 'NOT1' }, // ループ！
    ]
  };
  
  // 期待される動作（各ゲート1ns遅延）
  // t=0ns: [1,0,0]
  // t=1ns: [1,1,0]
  // t=2ns: [1,1,1]
  // t=3ns: [0,1,1]
  // t=4ns: [0,0,1]
  // t=5ns: [0,0,0]
  // t=6ns: [1,0,0] ← 初期状態に戻る（周期6ns）
});
```

### 検証ポイント
1. DELAYゲートなしで発振すること
2. 周期が理論値（3ゲート×2状態×1ns = 6ns）
3. 100周期以上安定動作

## 📊 リスク管理

### 技術的リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| パフォーマンス劣化 | 高 | Phase 1で早期測定 |
| 既存回路の非互換 | 高 | デフォルトOFF、警告表示 |
| UI複雑化 | 中 | 段階的追加、ユーザーテスト |

### スケジュールリスク
- **バッファ**: 各フェーズに20%の余裕
- **並行作業**: Phase 3-4は部分的に並行可能
- **早期中止**: Phase 2終了時点で判断ポイント

## 📈 成功指標

### 定量的指標
- Phase 2: 内部テスターの80%が問題なく使用
- Phase 3: パフォーマンス劣化10%以内
- Phase 4: 学習モード完走率が5%以上低下しない
- Phase 5: 上級機能の利用率30%以上

### 定性的指標
- 教育現場からのポジティブフィードバック
- 既存ユーザーからの苦情なし
- 技術ブログでの好意的な評価

## 🚀 ローンチ戦略

### ソフトローンチ（Phase 2-3）
- 内部ベータテスト（開発チーム）
- 限定ベータ（選ばれた教育者）
- フィードバック収集と改善

### 正式リリース（Phase 4完了後）
- リリースノート公開
- チュートリアル動画
- 教育者向けウェビナー

## 📝 関連ドキュメント

- [ARCHITECTURE.md](./ARCHITECTURE.md) - システムアーキテクチャ
- [GUIDELINES.md](./GUIDELINES.md) - 開発ガイドライン
- [EVENT_DRIVEN_SIMULATION.md](./EVENT_DRIVEN_SIMULATION.md) - イベント駆動の詳細

## 🔄 更新履歴

- 2024-06-18: 初版作成
- 今後: 各フェーズ完了時に更新

---

**承認**: _______________________  
**日付**: _______________________