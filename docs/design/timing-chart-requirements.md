# 📊 タイミングチャート機能 - 要件定義

## 🎯 概要
LogicCircのタイミングチャート機能は、回路内の信号変化を時間軸で可視化し、CLOCKとの同期やゲート間の遅延を理解できる教育的な波形解析ツールです。

## 🌟 目標
- **教育的価値**: デジタル回路の時間的動作を直感的に理解
- **専門性**: 実際のEDAツール（ModelSim、GTKWave）に近い体験
- **使いやすさ**: 初心者でも簡単に波形を確認できる

## 📋 機能要件

### 🔴 必須機能（MVP）

#### 1. 基本波形表示
- **信号トレース**: 選択したゲート・ワイヤーの信号変化を時間軸で表示
- **時間軸**: クリック可能な時間スケール（μs、ms、s）
- **信号レベル**: HIGH（1）/LOW（0）の明確な視覚表現
- **複数信号**: 最大10本の信号を同時表示

#### 2. CLOCK同期表示
- **CLOCKベース**: CLOCKゲートの周期を基準とした時間軸
- **立ち上がり/立ち下がり**: CLOCKエッジの明確な表示
- **周期表示**: 現在のCLOCK周期（50ms）の視覚化

#### 3. インタラクティブ操作
- **信号選択**: ゲートをクリックして波形追加
- **時間カーソル**: 特定時点での全信号状態を表示
- **ズーム**: 時間軸の拡大・縮小

#### 4. UI統合
- **表示パネル**: キャンバス下部に展開可能なタイミングチャートパネル
- **切り替え**: ワンクリックで表示/非表示
- **サイズ調整**: パネル高さの調整可能

### 🟡 重要機能（フェーズ2）

#### 5. 遅延シミュレーション
- **ゲート遅延**: 各ゲートタイプの遅延時間設定
- **配線遅延**: 長い配線による遅延効果
- **セットアップ/ホールド時間**: D-FFなどの時間制約

#### 6. 波形エクスポート
- **画像出力**: PNG/SVG形式での波形エクスポート
- **データ出力**: CSV形式での数値データ出力
- **VCD出力**: 標準的なValue Change Dump形式

### 🟢 拡張機能（将来）

#### 7. 高度な解析
- **信号統計**: 周波数、デューティ比、パルス幅測定
- **タイミング違反**: セットアップ/ホールド違反の検出
- **電力解析**: 信号変化による電力消費推定

## 🎨 UI/UX要件

### レイアウト設計
```
┌─────────────────────────────────────┐
│ キャンバス（回路図）                │
│                                     │
├─────────────────────────────────────┤
│ 📊 タイミングチャート               │ ← 展開可能
│ ┌─────┬─────────────────────────────┐ │
│ │信号名│ 波形表示                    │ │
│ ├─────┼─────────────────────────────┤ │
│ │CLK  │ ┌─┐   ┌─┐   ┌─┐         │ │
│ │A    │   ─────┐       ┌─────     │ │
│ │B    │       ─┐   ┌───┘         │ │
│ │OUT  │         ┌───┘             │ │
│ └─────┴─────────────────────────────┘ │
│   0ms  10ms  20ms  30ms  40ms        │
└─────────────────────────────────────────┘
```

### 操作フロー
1. **回路作成**: 通常通り回路を作成
2. **チャート表示**: 「📊 タイミングチャート」ボタンクリック
3. **信号選択**: 波形を見たいゲート/ワイヤーをクリック
4. **シミュレーション**: 自動的に波形が更新される
5. **解析**: 時間カーソルで詳細確認

## 🛠️ 技術要件

### データ構造
```typescript
interface TimingEvent {
  time: number;        // ms単位の時刻
  gateId: string;      // ゲートID
  pinType: 'input' | 'output';
  pinIndex: number;    // ピン番号
  value: boolean;      // 信号値
  source?: string;     // 変化の原因
}

interface TimingTrace {
  id: string;          // トレースID
  gateId: string;      // 監視対象ゲート
  pinType: 'input' | 'output';
  pinIndex: number;
  name: string;        // 表示名
  events: TimingEvent[]; // 時系列イベント
  color: string;       // 波形の色
}

interface TimingChartState {
  traces: TimingTrace[];     // 表示中の波形
  timeWindow: {             // 表示時間範囲
    start: number;          // 開始時刻(ms)
    end: number;            // 終了時刻(ms)
  };
  timeScale: number;        // 時間スケール
  isVisible: boolean;       // パネル表示状態
  cursor?: number;          // 時間カーソル位置
}
```

### 実装アーキテクチャ
```
src/
├── features/timing-chart/
│   ├── components/
│   │   ├── TimingChartPanel.tsx      # メインパネル
│   │   ├── WaveformRenderer.tsx      # 波形描画
│   │   ├── TimeAxis.tsx              # 時間軸
│   │   ├── SignalSelector.tsx        # 信号選択UI
│   │   └── TimeCursor.tsx            # 時間カーソル
│   ├── hooks/
│   │   ├── useTimingData.ts          # データ管理
│   │   ├── useWaveformCapture.ts     # 波形キャプチャ
│   │   └── useTimingAnalysis.ts      # 解析機能
│   └── stores/
│       └── timingChartSlice.ts       # Zustand状態管理
├── domain/timing/
│   ├── timingCapture.ts              # イベント捕捉
│   ├── waveformGeneration.ts         # 波形データ生成
│   └── timingAnalysis.ts             # タイミング解析
```

## 📊 パフォーマンス要件
- **リアルタイム更新**: 100ms以内でのデータ更新
- **大量データ**: 1000イベント/秒まで処理
- **メモリ効率**: 最大100MB以内
- **描画性能**: 60fps維持

## 🧪 テスト要件
- **単体テスト**: 各コンポーネントとロジック
- **E2Eテスト**: 波形表示とインタラクション
- **パフォーマンステスト**: 大規模回路での動作
- **視覚回帰テスト**: 波形描画の正確性

## 🎓 教育的考慮
- **段階的学習**: 基本波形から複雑な同期回路まで
- **説明文**: 各波形の意味を解説
- **例題回路**: タイミングチャート専用のサンプル
- **用語解説**: セットアップ時間、ホールド時間等

## 🚧 制約・注意点
- **ブラウザ制限**: Canvas/SVGの描画性能
- **メモリ使用量**: 長時間シミュレーションでのメモリ管理
- **教育目的**: 過度に複雑にしない
- **モバイル対応**: タッチ操作での使いやすさ

## 📅 実装スケジュール

### Phase 1: 基本実装（2-3セッション）
1. データ構造とZustand store
2. 基本UI（パネル表示/非表示）
3. 簡単な波形表示
4. CLOCK同期

### Phase 2: 機能拡張（2-3セッション）
1. インタラクティブ操作
2. 複数信号表示
3. 時間カーソル
4. 遅延シミュレーション

### Phase 3: 仕上げ（1-2セッション）
1. エクスポート機能
2. パフォーマンス最適化
3. テスト・ドキュメント
4. モバイル対応

---

**この要件定義に基づいて、革新的なタイミングチャート機能を実装します！** 🚀