<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌀 カオス発生器ライブデバッグ</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff88;
            margin: 0;
            padding: 20px;
        }
        .debug-panel {
            border: 2px solid #00ff88;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 255, 136, 0.05);
        }
        .status-line {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        .status-value {
            font-weight: bold;
        }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        .success { color: #00ff88; }
        .log-entry {
            padding: 2px 0;
            font-size: 12px;
        }
        .timestamp {
            color: #666;
        }
    </style>
</head>
<body>
    <h1>🚨 カオス発生器リアルタイム監視</h1>
    <p>このツールを使用してブラウザでカオス発生器を開き、問題の再現を確認してください。</p>
    
    <div class="debug-panel">
        <h3>📊 CLOCKゲート監視</h3>
        <div id="clock-status"></div>
    </div>
    
    <div class="debug-panel">
        <h3>💡 出力ゲート状態</h3>
        <div id="output-status"></div>
    </div>
    
    <div class="debug-panel">
        <h3>⚡ パフォーマンス監視</h3>
        <div id="performance-status"></div>
    </div>
    
    <div class="debug-panel">
        <h3>🔄 評価ログ</h3>
        <div id="evaluation-log"></div>
    </div>
    
    <div class="debug-panel">
        <h3>🛠️ デバッグコード（コンソールに貼り付け）</h3>
        <textarea readonly style="width: 100%; height: 300px; background: #111; color: #00ff88; border: 1px solid #333; font-family: 'Courier New', monospace;">
// 🚨 カオス発生器デバッグコード
// ブラウザのコンソールに以下をコピー&ペーストしてください

(() => {
    console.log('🌀 カオス発生器デバッグ開始');
    
    let isMonitoring = true;
    let logCount = 0;
    const maxLogs = 50;
    
    // ログ関数
    function debugLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const prefix = type === 'error' ? '❌' : type === 'warning' ? '⚠️' : '📝';
        console.log(`${prefix} [${timestamp}] ${message}`);
        
        logCount++;
        if (logCount > maxLogs) {
            console.clear();
            logCount = 0;
        }
    }
    
    // 状態監視関数
    function monitorCircuitState() {
        if (!isMonitoring) return;
        
        try {
            // Zustandストアの取得を試行
            const storeElements = document.querySelectorAll('[data-testid], [class*="canvas"], canvas');
            
            if (storeElements.length === 0) {
                debugLog('回路キャンバスが見つかりません', 'warning');
                return;
            }
            
            // React DevTools経由でのストア取得
            const reactRoot = document.querySelector('#root');
            if (reactRoot && reactRoot._reactInternalFiber) {
                debugLog('React内部状態にアクセス中...');
            }
            
            // ローカルストレージから状態確認
            const storedState = localStorage.getItem('circuit-store');
            if (storedState) {
                const parsed = JSON.parse(storedState);
                debugLog(`ローカルストレージ状態: ${Object.keys(parsed.state || {}).length}個のキー`);
            }
            
            // パフォーマンス監視
            const memInfo = performance.memory;
            if (memInfo) {
                const usedMB = Math.round(memInfo.usedJSHeapSize / 1024 / 1024);
                const totalMB = Math.round(memInfo.totalJSHeapSize / 1024 / 1024);
                debugLog(`メモリ使用量: ${usedMB}MB / ${totalMB}MB`);
            }
            
            // AnimationFrame の状態確認
            const now = performance.now();
            debugLog(`AnimationFrame時刻: ${now.toFixed(2)}ms`);
            
        } catch (error) {
            debugLog(`監視エラー: ${error.message}`, 'error');
        }
    }
    
    // CLOCKゲート特化監視
    function monitorClockGates() {
        try {
            // DOM上のCLOCKゲート要素を探す
            const clockElements = document.querySelectorAll('[data-gate-type="CLOCK"], [class*="clock"]');
            debugLog(`DOM上のCLOCKゲート要素: ${clockElements.length}個`);
            
            clockElements.forEach((element, index) => {
                const rect = element.getBoundingClientRect();
                const isVisible = rect.width > 0 && rect.height > 0;
                debugLog(`CLOCK ${index}: 表示=${isVisible}, 位置=(${rect.x.toFixed(0)}, ${rect.y.toFixed(0)})`);
            });
            
        } catch (error) {
            debugLog(`CLOCKゲート監視エラー: ${error.message}`, 'error');
        }
    }
    
    // 出力ゲート監視
    function monitorOutputGates() {
        try {
            const outputElements = document.querySelectorAll('[data-gate-type="OUTPUT"], [class*="output"]');
            let activeOutputs = 0;
            
            outputElements.forEach((element, index) => {
                const isActive = element.classList.contains('active') || 
                                element.style.fill === '#00ff88' ||
                                element.getAttribute('data-active') === 'true';
                if (isActive) activeOutputs++;
            });
            
            debugLog(`出力ゲート: ${activeOutputs}/${outputElements.length} がアクティブ`);
            
            if (outputElements.length > 0 && activeOutputs === 0) {
                debugLog('🚨 全出力ゲートが非アクティブ状態！', 'error');
            }
            
        } catch (error) {
            debugLog(`出力ゲート監視エラー: ${error.message}`, 'error');
        }
    }
    
    // エラー監視
    const originalError = console.error;
    console.error = function(...args) {
        debugLog(`コンソールエラー: ${args.join(' ')}`, 'error');
        originalError.apply(console, args);
    };
    
    // メインループ
    function mainLoop() {
        if (!isMonitoring) return;
        
        monitorCircuitState();
        monitorClockGates();
        monitorOutputGates();
        
        setTimeout(mainLoop, 2000); // 2秒間隔
    }
    
    // 開始
    debugLog('監視開始！カオス発生器を開いて問題を再現してください');
    mainLoop();
    
    // 停止用
    window.stopChaosDebug = () => {
        isMonitoring = false;
        debugLog('監視停止', 'warning');
    };
    
    // 手動状態確認用
    window.checkChaosState = () => {
        debugLog('=== 手動状態確認 ===');
        monitorCircuitState();
        monitorClockGates();
        monitorOutputGates();
    };
    
    console.log('🛠️ 停止: stopChaosDebug()');
    console.log('🔍 手動確認: checkChaosState()');
})();
        </textarea>
    </div>
    
    <div class="debug-panel">
        <h3>📋 監視手順</h3>
        <ol>
            <li>上記のデバッグコードをコピー</li>
            <li>ブラウザでカオス発生器を開く（ギャラリーモードまたは作成モード）</li>
            <li>開発者ツール（F12）のコンソールタブを開く</li>
            <li>デバッグコードを貼り付けて実行</li>
            <li>問題が発生するまで待機（2秒間隔で自動監視）</li>
            <li>出力が停止したタイミングのログを確認</li>
        </ol>
    </div>
    
    <script>
        // このページでは実際の監視は行わず、手順を表示するのみ
        document.addEventListener('DOMContentLoaded', function() {
            const clockStatus = document.getElementById('clock-status');
            const outputStatus = document.getElementById('output-status');
            const performanceStatus = document.getElementById('performance-status');
            const evaluationLog = document.getElementById('evaluation-log');
            
            clockStatus.innerHTML = '<div class="status-line"><span>このページは監視ツールです</span><span class="warning">実際の監視は上記コードを使用</span></div>';
            outputStatus.innerHTML = '<div class="status-line"><span>カオス発生器を開いてデバッグコードを実行してください</span></div>';
            performanceStatus.innerHTML = '<div class="status-line"><span>ブラウザコンソールで詳細ログを確認</span></div>';
            evaluationLog.innerHTML = '<div class="log-entry"><span class="timestamp">[待機中]</span> デバッグツール準備完了</div>';
        });
    </script>
</body>
</html>