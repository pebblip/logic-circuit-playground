# 論理回路プレイグラウンド - 開発ガイド for Claude

## 🎯 プロジェクト概要
このプロジェクトは教育用の論理回路シミュレータです。ユーザーは様々な論理ゲートを配置・接続して回路を作成し、リアルタイムでシミュレーションできます。

### 主な特徴
- ドラッグ&ドロップによる直感的なゲート配置
- リアルタイムシミュレーション（coreAPI移行完了）
- 視覚的フィードバック（アクティブな信号の表示）
- 特殊ゲート対応（CLOCK、D-FF、SR-LATCH、MUX）
- **カスタムゲート作成機能**（回路から新しいゲートを作成）
- **真理値表自動生成・表示機能**
- **学習モード**（21レッスン、構造化コンテンツ）
- **整備されたコード基盤**（ESLint準拠、型安全性）
- レスポンシブデザイン対応（デスクトップ・タブレット・モバイル）

## 📚 ドキュメント構造

### 必読ドキュメント
1. `docs/development/GUIDELINES.md` - 開発ガイドライン（コーディング規約、品質基準）
2. `docs/development/ARCHITECTURE.md` - アーキテクチャ（Hybrid Feature-Domain）
3. `docs/development/ROADMAP.md` - 開発ロードマップ
4. `docs/PROJECT_BLUEPRINT.md` - プロジェクト全体の青写真

### モックアップ
- `docs/design/mockups/final-gate-design.html` - ゲートの最終デザイン仕様

## 🛠️ 開発ルール

### 基本原則
1. **動く製品を最優先** - 完璧よりも動作を重視
2. **段階的な改善** - 小さな変更を積み重ねる
3. **ユーザーファースト** - 使いやすさを常に意識

### コーディング規約
```typescript
// ✅ 良い例：明確な型定義
interface Gate {
  id: string;
  type: GateType;
  position: Position;
  inputs: string[];
  output: boolean;
  metadata?: any; // 特殊ゲート用
}

// ❌ 悪い例：anyの乱用
const gate: any = { ... };
```

### テスト実行
```bash
# 単体テストの実行（推奨：高速で詳細）
npm run test

# 特定のテストファイルのみ実行
npm run test -- tests/components/TruthTableDisplay.test.tsx

# E2Eテストの実行（開発中によく使う）
npm run test:e2e

# 特定のE2Eテストのみ実行
npx cypress run --spec "cypress/e2e/特定のテスト.cy.js"

# ヘッドレスモードでE2Eテスト
npm run test:e2e:headless

# TypeScriptのチェック
npm run typecheck

# ビルドの確認
npm run build
```

### 重要：テスト実行ガイドライン
- 単体テストなどが長すぎる場合は失敗とみなし、中断して原因を分析する
- 新機能追加時は必ず対応するテストケースを追加
- カスタムゲート関連機能は`TruthTableDisplay.test.tsx`を参考にテスト作成

## 📝 コミットルール

### Conventional Commits形式
```bash
# 機能追加
feat: 特殊ゲート（CLOCK、D-FF）を実装

# バグ修正
fix: SR-LATCHの接続線のずれを修正

# ドキュメント
docs: 開発ガイドラインを更新

# リファクタリング
refactor: ゲートファクトリーパターンを導入

# テスト
test: 特殊ゲートの統合テストを追加
```

### コミット時の注意
- author情報にClaudeを含めない
- "Generated by Claude"のようなコメントは不要

## 🏗️ アーキテクチャ要点

### Hybrid Feature-Domain Architecture
```
src/
├── domain/                    # ドメインロジック
│   ├── analysis/             # 真理値表生成・回路分析
│   ├── circuit/              # 回路レイアウト・操作
│   └── simulation/           # coreAPI：純粋関数シミュレーション
│       └── core/             # Result<T,E>パターン実装
├── stores/                   # Zustand状態管理
│   └── slices/              # 機能別スライス
├── components/               # UIコンポーネント
│   ├── dialogs/             # モーダルダイアログ
│   ├── gate/                # ゲート関連コンポーネント
│   ├── layouts/             # レスポンシブレイアウト
│   └── tool-palette/        # ツールパレット
├── features/                 # 機能別実装
│   ├── gallery/             # ギャラリーモード
│   ├── learning-mode/       # 学習モード
│   └── puzzle-mode/         # パズルモード
├── hooks/                   # カスタムフック
├── infrastructure/         # インフラ層
└── types/                  # 型定義
```

### 重要ファイル
- `src/stores/circuitStore.ts` - 中央状態管理
- `src/domain/simulation/core/circuitEvaluation.ts` - coreAPI回路評価
- `src/domain/simulation/core/gateEvaluation.ts` - coreAPIゲート評価
- `src/components/TruthTableDisplay.tsx` - 真理値表表示
- `src/components/ToolPalette.tsx` - カスタムゲート作成
- `src/domain/analysis/pinPositionCalculator.ts` - ピン位置計算
- `src/models/gates/GateFactory.ts` - ゲート生成ファクトリー
- `src/features/learning-mode/` - 学習モード（21レッスン）

## 🔧 よくある問題と解決方法

### 1. ワイヤー接続がずれる
**原因**: ピン位置の計算ミス（特にカスタムゲート）
**解決**: `src/domain/analysis/pinPositionCalculator.ts`の計算式を確認
**修正済み**: CustomGateRendererと計算式を統一済み

### 2. 真理値表の出力ヘッダーが表示されない
**原因**: `definition.outputs`の`name`プロパティが未定義
**解決**: `TruthTableDisplay.tsx`の`safeOutputNames`でフォールバック
**修正済み**: 防御的プログラミングで解決

### 3. カスタムゲート作成ダイアログが開かない
**原因**: イベント伝播やprops受け渡しの問題
**解決**: `useCustomGateDialog.ts`でカスタムイベントを確認
**修正済み**: デバッグログ追加とイベント処理修正

### 4. 複数CLOCKゲートの同期問題
**原因**: Canvas.tsxのuseEffect依存配列が不完全
**解決**: CLOCKゲート数とisRunning状態の両方を監視
**修正済み**: 依存配列を修正して正常に動作

### 5. シミュレーションが動かない
**原因**: coreAPI移行により評価方式が変更
**解決**: `src/domain/simulation/core/`のcoreAPIを使用
**修正済み**: Result<T,E>パターンで実装

### 6. TypeScriptエラー・コード品質
**対策**: 
- まず`npm run typecheck`で確認
- 型定義は`src/types/`に集約
- coreAPIでは`any`を避けて型安全に実装
- ESLintエラーは`npm run lint`で確認・修正
- 未使用変数は`_`プレフィックスで無効化または削除

## 💡 開発のコツ

### 座標系の扱い
- SVG座標系を使用（左上が原点）
- マウスイベントではSVG座標に変換が必要
```typescript
const point = svg.createSVGPoint();
point.x = event.clientX;
point.y = event.clientY;
const svgPoint = point.matrixTransform(svg.getScreenCTM()!.inverse());
```

### 状態管理
- Zustandを使用（シンプルで高速）
- Immerは使わない（プロキシ問題を避ける）
- 更新は必ずimmutableに
- coreAPIではResult<T,E>パターンでエラーハンドリング

### coreAPIシミュレーション（推奨）
```typescript
// ✅ 良い例：coreAPI使用
const result = evaluateCircuit(circuit, config);
if (result.success) {
  const { circuit: updatedCircuit } = result.data;
  // 成功時の処理
} else {
  console.error('Evaluation failed:', result.error.message);
}

// ❌ 旧API（非推奨）
const updatedCircuit = evaluateCircuitLegacy(circuit); // エラーが見えない
```

### カスタムゲート開発
- `definition.outputs`の`name`プロパティは必須
- 真理値表は自動生成される
- ピン位置計算は`pinPositionCalculator.ts`で統一

### パフォーマンス
- 不要な再レンダリングを避ける
- CLOCKゲートの更新は20Hz（50ms間隔）で十分
- 真理値表は計算コストが高いため、キャッシュを活用

## 🚀 次のステップの検討方法

### 優先順位の決め方
1. ROADMAPの現在のフェーズを確認
2. ユーザーから報告された問題を優先
3. 機能追加よりバグ修正を優先

### 新機能追加時
1. まずモックアップを確認
2. 既存コードを壊さないよう注意
3. 必ずE2Eテストを追加
4. 小さな単位でコミット

## 📋 チェックリスト

### 開発前
- [ ] 最新のmainブランチを取得
- [ ] ROADMAPで現在のフェーズを確認
- [ ] 関連するドキュメントを読む

### 実装中
- [ ] TypeScriptの型を正しく使用
- [ ] エラーハンドリングを適切に
- [ ] パフォーマンスを意識

### コミット前
- [ ] `npm run typecheck`でエラーなし
- [ ] `npm run lint`でエラーなし（警告は許容）
- [ ] `npm run test`で単体テストが通る
- [ ] 関連するE2Eテストが通る
- [ ] コミットメッセージが規約に従っている
- [ ] カスタムゲート関連の変更は真理値表表示も確認

## 🎨 UI/UXの指針

### モックアップ準拠
- ゲートサイズは`docs/design/mockups/final-gate-design.html`を参照
- 色使いは既存のCSSに従う（#00ff88がアクティブ色）

### ユーザビリティ
- クリック領域は見た目より大きく（特にピン）
- 視覚的フィードバックは必須
- エラーは分かりやすく表示

## 📌 重要な注意事項

1. **ViewModelパターンは使わない**（Zustandで十分）
2. **過度な抽象化は避ける**（シンプルに保つ）
3. **動作確認は必ずブラウザで**（テストだけでは不十分）

## 📝 最新の開発状況

### 完成済みの機能 ✅
- **学習モード**: 21レッスンの構造化コンテンツ実装済み
  - ⭐⭐⭐ 完全ブラッシュアップ済み: 17レッスン（81%）
  - ⭐⭐ 基本内容は充実、視覚要素改善中: 4レッスン（全加算器、4ビット加算器、比較器、レジスタ）
- **フリーモード**: 基本機能は動作（カスタムゲート作成含む）
- **真理値表表示**: 自動生成・表示機能
- **coreAPIシミュレーション**: Result<T,E>パターンで型安全
- **レスポンシブ対応**: デスクトップ・タブレット・モバイル

### 部分的実装 🟡
- **パズルモード**: 10問のみ実装（目標120問）
- **ギャラリーモード**: 基本構造のみ（UI未実装）
- **キーボードショートカット**: 一部のみ実装

### 未実装機能 ❌
- 元に戻す/やり直し（Ctrl+Z/Y）
- 回路保存ショートカット（Ctrl+S）
- コピー&ペースト（Ctrl+C/V）
- ゲート自動整列
- URL共有
- PNG画像エクスポート
- 回路自動検証
- パフォーマンス計測

### 最近の改善
- **API統一**: `pure`→`core`に命名を統一
- **コード品質向上**: ESLintエラーを警告レベルに改善（1455→140）
- **型安全性強化**: TypeScript strict mode有効化、型エラーを解消
- **ドキュメント改善**: 表現の統一と現状に合わせた更新

## 🚀 次のステップ

### 🎯 最優先タスク: 学習モード100%ブラッシュアップ完遂

現在の進捗: **17/21レッスン（81%）完了** → **目標: 21/21レッスン（100%）**

### 残り4レッスンの具体的改善内容 🔴

#### 1. **レジスタ**（register-lesson.ts）
現状: 基本説明のみ
改善点:
- [ ] CPU内部でのレジスタの役割を示すブロック図
- [ ] 並列データ処理の動作を視覚化
- [ ] 汎用レジスタ vs 特殊レジスタの比較表
- [ ] パイプライン処理での使用例

#### 2. **全加算器**（full-adder-lesson.ts）
現状: 真理値表と基本説明
改善点:
- [ ] 半加算器2つとORゲートで構成する詳細回路図
- [ ] キャリー伝播の段階的アニメーション説明
- [ ] ゲートレベルでの信号の流れ図
- [ ] 最適化された実装（5ゲート版）の紹介

#### 3. **4ビット加算器**（4bit-adder-lesson.ts）
現状: リップルキャリーの説明
改善点:
- [ ] 4つの全加算器のカスケード接続図
- [ ] キャリー伝播遅延の視覚的説明
- [ ] 2進数計算の段階的実行例（アニメーション風）
- [ ] キャリールックアヘッドとの比較

#### 4. **比較器**（comparator-lesson.ts）
現状: 基本的な論理設計
改善点:
- [ ] 実用的な応用例（ソート回路、範囲チェック）
- [ ] 多ビット比較器への拡張方法の図解
- [ ] 符号付き数値の比較説明
- [ ] CPUの分岐命令での使用例

### 作業手順
1. 各レッスンファイルを開き、上記改善点を`content`配列に追加
2. 新しいコンテンツタイプ（図表など）が必要な場合は対応するレンダラーを作成
3. 各レッスン完了後、動作確認とビジュアル確認を実施

---

### その他のタスク（ブラッシュアップ完了後）

#### 優先度：高（Phase 2完了）🟡
1. **キーボードショートカット実装**
   - Delete: ゲート削除
   - Ctrl+Z/Y: 元に戻す/やり直し（履歴機能）
   - Ctrl+S: 回路保存
   - Ctrl+C/V: コピー&ペースト

2. **UI/UXの改善**
   - ヘッダーの制御（モード別に表示/非表示）
   - ズームボタンの配置改善（右下から移動）
   - レッスンパネルのレイアウト最適化
   - モバイル表示の改善（特にツールパレット）

#### 優先度：中（機能拡充）🟢
3. **パズルモード拡充**（10問→120問）
   - 難易度別カテゴリ整理
   - ヒントシステムの実装
   - 進捗管理とランキング

4. **ギャラリーモード実装**（UIと機能の実装）
   - サンプル回路の充実
   - カテゴリ別表示
   - 作品投稿機能（将来）
   - いいね・コメント機能（将来）

5. **エラーハンドリング強化**
   - 無効な接続の視覚的警告
   - ユーザーフレンドリーなエラーメッセージ
   - 操作ガイドの改善

#### 優先度：低（将来の拡張）⚪
6. **未実装機能**
   - 整列機能（選択ゲートの自動整列）
   - URL共有機能
   - PNG画像エクスポート
   - 回路自動検証
   - パフォーマンス計測表示

7. **技術的改善**
   - ESLint警告140個の段階的削減
   - パフォーマンス最適化（大規模回路対応）
   - テストカバレッジの向上

## 📌 まとめ

**最優先は学習モード100%ブラッシュアップの完遂です！**
- 残り4レッスン（レジスタ、全加算器、4ビット加算器、比較器）
- 主に視覚的要素（図表、回路図、アニメーション風説明）の追加
- 完了すれば全21レッスンが最高品質に

その後、Phase 2（UI/UX改善）→ 機能拡充の順で進めます。

---

プロジェクトの進化に合わせて、このドキュメントも更新してください。