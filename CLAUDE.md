# 論理回路プレイグラウンド - 開発ガイド for Claude

## 🎯 プロジェクト概要
このプロジェクトは教育用の論理回路シミュレータです。ユーザーは様々な論理ゲートを配置・接続して回路を作成し、リアルタイムでシミュレーションできます。

### 主な特徴
- ワンクリックでゲート配置
- リアルタイムシミュレーション 
- 視覚的フィードバック（アクティブな信号の表示）
- 特殊ゲート対応（CLOCK、D-FF、SR-LATCH、MUX）

## 📚 ドキュメント構造

### 必読ドキュメント
1. `docs/development/GUIDELINES.md` - 開発ガイドライン（コーディング規約、品質基準）
2. `docs/development/ARCHITECTURE.md` - アーキテクチャ（Hybrid Feature-Domain）
3. `docs/development/ROADMAP.md` - 開発ロードマップ
4. `docs/PROJECT_BLUEPRINT.md` - プロジェクト全体の青写真

### モックアップ
- `docs/design/mockups/final-gate-design.html` - ゲートの最終デザイン仕様

## 🛠️ 開発ルール

### 基本原則
1. **動く製品を最優先** - 完璧よりも動作を重視
2. **段階的な改善** - 小さな変更を積み重ねる
3. **ユーザーファースト** - 使いやすさを常に意識

### コーディング規約
```typescript
// ✅ 良い例：明確な型定義
interface Gate {
  id: string;
  type: GateType;
  position: Position;
  inputs: string[];
  output: boolean;
  metadata?: any; // 特殊ゲート用
}

// ❌ 悪い例：anyの乱用
const gate: any = { ... };
```

### テスト実行
```bash
# E2Eテストの実行（開発中によく使う）
npm run test:e2e

# 特定のテストファイルのみ実行
npx cypress run --spec "cypress/e2e/特定のテスト.cy.js"

# ヘッドレスモードでテスト
npm run test:e2e:headless

# TypeScriptのチェック
npm run typecheck

# ビルドの確認
npm run build
```

### 重要：テストが長すぎる場合
単体テストなどが長すぎる場合は失敗とみなし、中断して原因を分析してください。

## 📝 コミットルール

### Conventional Commits形式
```bash
# 機能追加
feat: 特殊ゲート（CLOCK、D-FF）を実装

# バグ修正
fix: SR-LATCHの接続線のずれを修正

# ドキュメント
docs: 開発ガイドラインを更新

# リファクタリング
refactor: ゲートファクトリーパターンを導入

# テスト
test: 特殊ゲートの統合テストを追加
```

### コミット時の注意
- author情報にClaudeを含めない
- "Generated by Claude"のようなコメントは不要

## 🏗️ アーキテクチャ要点

### Hybrid Feature-Domain Architecture
```
src/
├── domain/          # ビジネスロジック
│   ├── services/    # GatePlacement, CollisionDetector等
│   └── stores/      # Zustandストア
├── entities/        # ドメインモデル（ゲート定義）
├── features/        # 機能別のUI実装
│   ├── circuit-editor/
│   └── learning-mode/
└── shared/          # 共通ユーティリティ
```

### 重要ファイル
- `src/stores/circuitStore.ts` - 中央状態管理
- `src/utils/simulation.ts` - 回路シミュレーションロジック
- `src/components/Gate.tsx` - ゲートの描画
- `src/components/Wire.tsx` - ワイヤーの描画
- `src/models/gates/GateFactory.ts` - ゲート生成ファクトリー

## 🔧 よくある問題と解決方法

### 1. ワイヤー接続がずれる
**原因**: ピン位置の計算ミス
**解決**: `Wire.tsx`の`getOutputPinPosition`/`getInputPinPosition`を確認

### 2. ゲートがドラッグできない
**原因**: ワイヤー描画中のロック
**確認**: `Gate.tsx`の`handleMouseDown`でワイヤー描画中チェック

### 3. シミュレーションが動かない
**原因**: CLOCKゲートがある場合の定期更新が必要
**解決**: `Canvas.tsx`でCLOCKゲート存在時の`setInterval`実装

### 4. TypeScriptエラー
**対策**: 
- まず`npm run typecheck`で確認
- 型定義は`src/types/`に集約
- 不明な型は一時的に`any`でも可（後で修正）

## 💡 開発のコツ

### 座標系の扱い
- SVG座標系を使用（左上が原点）
- マウスイベントではSVG座標に変換が必要
```typescript
const point = svg.createSVGPoint();
point.x = event.clientX;
point.y = event.clientY;
const svgPoint = point.matrixTransform(svg.getScreenCTM()!.inverse());
```

### 状態管理
- Zustandを使用（シンプルで高速）
- Immerは使わない（プロキシ問題を避ける）
- 更新は必ずimmutableに

### パフォーマンス
- 不要な再レンダリングを避ける
- CLOCKゲートの更新は20Hz（50ms間隔）で十分

## 🚀 次のステップの検討方法

### 優先順位の決め方
1. ROADMAPの現在のフェーズを確認
2. ユーザーから報告された問題を優先
3. 機能追加よりバグ修正を優先

### 新機能追加時
1. まずモックアップを確認
2. 既存コードを壊さないよう注意
3. 必ずE2Eテストを追加
4. 小さな単位でコミット

## 📋 チェックリスト

### 開発前
- [ ] 最新のmainブランチを取得
- [ ] ROADMAPで現在のフェーズを確認
- [ ] 関連するドキュメントを読む

### 実装中
- [ ] TypeScriptの型を正しく使用
- [ ] エラーハンドリングを適切に
- [ ] パフォーマンスを意識

### コミット前
- [ ] `npm run typecheck`でエラーなし
- [ ] 関連するE2Eテストが通る
- [ ] コミットメッセージが規約に従っている

## 🎨 UI/UXの指針

### モックアップ準拠
- ゲートサイズは`docs/design/mockups/final-gate-design.html`を参照
- 色使いは既存のCSSに従う（#00ff88がアクティブ色）

### ユーザビリティ
- クリック領域は見た目より大きく（特にピン）
- 視覚的フィードバックは必須
- エラーは分かりやすく表示

## 📌 重要な注意事項

1. **src_old**ディレクトリは参考程度に（バグが多い）
2. **ViewModelパターンは使わない**（Zustandで十分）
3. **過度な抽象化は避ける**（シンプルに保つ）
4. **動作確認は必ずブラウザで**（テストだけでは不十分）

---

最終更新: 2025年1月
プロジェクトの進化に合わせて、このドキュメントも更新してください。