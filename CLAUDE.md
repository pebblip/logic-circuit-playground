# 論理回路プレイグラウンド - 開発ガイド for Claude

## 🎯 プロジェクト概要
このプロジェクトは教育用の論理回路シミュレータです。ユーザーは様々な論理ゲートを配置・接続して回路を作成し、リアルタイムでシミュレーションできます。

### 主な特徴
- ドラッグ&ドロップによる直感的なゲート配置
- リアルタイムシミュレーション（coreAPI移行完了）
- 視覚的フィードバック（アクティブな信号の表示）
- 特殊ゲート対応（CLOCK、D-FF、SR-LATCH、MUX）
- **カスタムゲート作成機能**（回路から新しいゲートを作成）
- **真理値表自動生成・表示機能**
- **学習モード**（21レッスン、構造化コンテンツ）
- **整備されたコード基盤**（ESLint準拠、型安全性）
- レスポンシブデザイン対応（デスクトップ・タブレット・モバイル）

## 📚 ドキュメント構造

### 必読ドキュメント
1. `docs/development/GUIDELINES.md` - 開発ガイドライン（コーディング規約、品質基準）
2. `docs/development/ARCHITECTURE.md` - アーキテクチャ（Hybrid Feature-Domain）
3. `docs/development/ROADMAP.md` - 開発ロードマップ
4. `docs/PROJECT_BLUEPRINT.md` - プロジェクト全体の青写真

### モックアップ
- `docs/design/mockups/final-gate-design.html` - ゲートの最終デザイン仕様

## 🛠️ 開発ルール

### 基本原則
1. **動く製品を最優先** - 完璧よりも動作を重視
2. **段階的な改善** - 小さな変更を積み重ねる
3. **ユーザーファースト** - 使いやすさを常に意識

### コーディング規約
```typescript
// ✅ 良い例：明確な型定義
interface Gate {
  id: string;
  type: GateType;
  position: Position;
  inputs: string[];
  output: boolean;
  metadata?: any; // 特殊ゲート用
}

// ❌ 悪い例：anyの乱用
const gate: any = { ... };
```

### テスト実行
```bash
# 単体テストの実行（推奨：高速で詳細）
npm run test

# 特定のテストファイルのみ実行
npm run test -- tests/components/TruthTableDisplay.test.tsx

# E2Eテストの実行（開発中によく使う）
npm run test:e2e

# 特定のE2Eテストのみ実行
npx cypress run --spec "cypress/e2e/特定のテスト.cy.js"

# ヘッドレスモードでE2Eテスト
npm run test:e2e:headless

# TypeScriptのチェック
npm run typecheck

# ビルドの確認
npm run build
```

### 重要：テスト実行ガイドライン
- 単体テストなどが長すぎる場合は失敗とみなし、中断して原因を分析する
- 新機能追加時は必ず対応するテストケースを追加
- カスタムゲート関連機能は`TruthTableDisplay.test.tsx`を参考にテスト作成

## 📝 コミットルール

### Conventional Commits形式
```bash
# 機能追加
feat: 特殊ゲート（CLOCK、D-FF）を実装

# バグ修正
fix: SR-LATCHの接続線のずれを修正

# ドキュメント
docs: 開発ガイドラインを更新

# リファクタリング
refactor: ゲートファクトリーパターンを導入

# テスト
test: 特殊ゲートの統合テストを追加
```

### コミット時の注意
- author情報にClaudeを含めない
- "Generated by Claude"のようなコメントは不要

## 🏗️ アーキテクチャ要点

### Hybrid Feature-Domain Architecture
```
src/
├── domain/                    # ドメインロジック
│   ├── analysis/             # 真理値表生成・回路分析
│   ├── circuit/              # 回路レイアウト・操作
│   └── simulation/           # coreAPI：純粋関数シミュレーション
│       └── core/             # Result<T,E>パターン実装
├── stores/                   # Zustand状態管理
│   └── slices/              # 機能別スライス
├── components/               # UIコンポーネント
│   ├── dialogs/             # モーダルダイアログ
│   ├── gate/                # ゲート関連コンポーネント
│   ├── layouts/             # レスポンシブレイアウト
│   └── tool-palette/        # ツールパレット
├── features/                 # 機能別実装
│   ├── gallery/             # ギャラリーモード
│   ├── learning-mode/       # 学習モード
│   └── puzzle-mode/         # パズルモード
├── hooks/                   # カスタムフック
├── infrastructure/         # インフラ層
└── types/                  # 型定義
```

### 重要ファイル
- `src/stores/circuitStore.ts` - 中央状態管理
- `src/domain/simulation/core/circuitEvaluation.ts` - coreAPI回路評価
- `src/domain/simulation/core/gateEvaluation.ts` - coreAPIゲート評価
- `src/components/TruthTableDisplay.tsx` - 真理値表表示
- `src/components/ToolPalette.tsx` - カスタムゲート作成
- `src/domain/analysis/pinPositionCalculator.ts` - ピン位置計算
- `src/models/gates/GateFactory.ts` - ゲート生成ファクトリー
- `src/features/learning-mode/` - 学習モード（21レッスン）

## 🔧 よくある問題と解決方法

### 1. ワイヤー接続がずれる
**原因**: ピン位置の計算ミス（特にカスタムゲート）
**解決**: `src/domain/analysis/pinPositionCalculator.ts`の計算式を確認
**修正済み**: CustomGateRendererと計算式を統一済み

### 2. 真理値表の出力ヘッダーが表示されない
**原因**: `definition.outputs`の`name`プロパティが未定義
**解決**: `TruthTableDisplay.tsx`の`safeOutputNames`でフォールバック
**修正済み**: 防御的プログラミングで解決

### 3. カスタムゲート作成ダイアログが開かない
**原因**: イベント伝播やprops受け渡しの問題
**解決**: `useCustomGateDialog.ts`でカスタムイベントを確認
**修正済み**: デバッグログ追加とイベント処理修正

### 4. 複数CLOCKゲートの同期問題
**原因**: Canvas.tsxのuseEffect依存配列が不完全
**解決**: CLOCKゲート数とisRunning状態の両方を監視
**修正済み**: 依存配列を修正して正常に動作

### 5. シミュレーションが動かない
**原因**: coreAPI移行により評価方式が変更
**解決**: `src/domain/simulation/core/`のcoreAPIを使用
**修正済み**: Result<T,E>パターンで実装

### 6. TypeScriptエラー・コード品質
**対策**: 
- まず`npm run typecheck`で確認
- 型定義は`src/types/`に集約
- coreAPIでは`any`を避けて型安全に実装
- ESLintエラーは`npm run lint`で確認・修正
- 未使用変数は`_`プレフィックスで無効化または削除

## 💡 開発のコツ

### 座標系の扱い
- SVG座標系を使用（左上が原点）
- マウスイベントではSVG座標に変換が必要
```typescript
const point = svg.createSVGPoint();
point.x = event.clientX;
point.y = event.clientY;
const svgPoint = point.matrixTransform(svg.getScreenCTM()!.inverse());
```

### 状態管理
- Zustandを使用（シンプルで高速）
- Immerは使わない（プロキシ問題を避ける）
- 更新は必ずimmutableに
- coreAPIではResult<T,E>パターンでエラーハンドリング

### coreAPIシミュレーション（推奨）
```typescript
// ✅ 良い例：coreAPI使用
const result = evaluateCircuit(circuit, config);
if (result.success) {
  const { circuit: updatedCircuit } = result.data;
  // 成功時の処理
} else {
  console.error('Evaluation failed:', result.error.message);
}

// ❌ 旧API（非推奨）
const updatedCircuit = evaluateCircuitLegacy(circuit); // エラーが見えない
```

### カスタムゲート開発
- `definition.outputs`の`name`プロパティは必須
- 真理値表は自動生成される
- ピン位置計算は`pinPositionCalculator.ts`で統一

### パフォーマンス
- 不要な再レンダリングを避ける
- CLOCKゲートの更新は20Hz（50ms間隔）で十分
- 真理値表は計算コストが高いため、キャッシュを活用

## 🚀 次のステップの検討方法

### 優先順位の決め方
1. ROADMAPの現在のフェーズを確認
2. ユーザーから報告された問題を優先
3. 機能追加よりバグ修正を優先

### 新機能追加時
1. まずモックアップを確認
2. 既存コードを壊さないよう注意
3. 必ずE2Eテストを追加
4. 小さな単位でコミット

## 📋 チェックリスト

### 開発前
- [ ] 最新のmainブランチを取得
- [ ] ROADMAPで現在のフェーズを確認
- [ ] 関連するドキュメントを読む

### 実装中
- [ ] TypeScriptの型を正しく使用
- [ ] エラーハンドリングを適切に
- [ ] パフォーマンスを意識

### コミット前
- [ ] `npm run typecheck`でエラーなし
- [ ] `npm run lint`でエラーなし（警告は許容）
- [ ] `npm run test`で単体テストが通る
- [ ] 関連するE2Eテストが通る
- [ ] コミットメッセージが規約に従っている
- [ ] カスタムゲート関連の変更は真理値表表示も確認

## 🎨 UI/UXの指針

### モックアップ準拠
- ゲートサイズは`docs/design/mockups/final-gate-design.html`を参照
- 色使いは既存のCSSに従う（#00ff88がアクティブ色）

### ユーザビリティ
- クリック領域は見た目より大きく（特にピン）
- 視覚的フィードバックは必須
- エラーは分かりやすく表示

## 📌 重要な注意事項

1. **ViewModelパターンは使わない**（Zustandで十分）
2. **過度な抽象化は避ける**（シンプルに保つ）
3. **動作確認は必ずブラウザで**（テストだけでは不十分）

## 📝 最新の開発状況

### 最近の大きな改善
- **学習モード完成**: 21レッスンの構造化コンテンツ
- **API統一**: `pure`→`core`に命名を統一、新旧の区別を排除
- **コード品質向上**: ESLintエラーを警告レベルに改善（1455→140）
- **型安全性強化**: TypeScript strict mode有効化、型エラーを解消

---

プロジェクトの進化に合わせて、このドキュメントも更新してください。