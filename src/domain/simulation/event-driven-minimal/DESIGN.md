# 最小限のイベント駆動エンジン設計書

## 🎯 目的
循環回路（フィードバックループ）を可能にする最小限の実装

## 📋 必須要件
1. **NORゲートでSR Latchが作れる**
2. **リングオシレータが動作する**
3. **既存システムと共存可能**
4. **1週間で実装完了**

## 🏗️ アーキテクチャ

### Phase 1: 最小限の動作（3日）
```typescript
class MinimalEventDrivenEngine {
  // イベントキュー（時刻順）
  private events: Array<{
    time: number;
    gateId: string;
    newValue: boolean;
  }>;
  
  // 現在の回路状態
  private state: Map<string, boolean>;
  
  // デルタサイクル処理
  processDeltaCycle(): boolean {
    // 1. 現在時刻のイベントを全て処理
    // 2. 新しいイベントが発生したら追加
    // 3. 収束するまで繰り返し
  }
}
```

### Phase 2: 既存システムとの統合（2日）
```typescript
interface CircuitEvaluator {
  canHandle(circuit: Circuit): boolean;
  evaluate(circuit: Circuit): Circuit;
}

class HybridEvaluator {
  // 循環あり → EventDrivenEngine
  // 循環なし → 既存のトポロジカルソート
}
```

### Phase 3: 最適化とテスト（2日）
- パフォーマンス測定
- エッジケースのテスト
- UI統合

## 🧪 テストケース

### 1. SR Latch（最重要）
```
     ┌─────┐
S ───┤ NOR ├─── Q
     │     │ ┌─┐
     └──┬──┘ │ │
        │    │ │
        └────┘ │
               │
     ┌─────┐   │
R ───┤ NOR ├───┴─ Q̄
     │     │
     └──┬──┘
        │
        └─────────
```

### 2. リングオシレータ
```
     ┌─────┐    ┌─────┐    ┌─────┐
  ┌──┤ NOT ├────┤ NOT ├────┤ NOT ├──┐
  │  └─────┘    └─────┘    └─────┘  │
  │                                  │
  └──────────────────────────────────┘
```

### 3. クロック分周器
```
       ┌──────┐
CLK ───┤      │
       │ D-FF ├─── Q (1/2 CLK)
   ┌───┤      │
   │   └──────┘
   │      │
   └──────┘ (Q̄ → D)
```

## 🚀 実装順序

### Day 1-2: コア実装
- [ ] イベントキュー基本操作
- [ ] デルタサイクル処理
- [ ] 単純な循環検出

### Day 3-4: 統合
- [ ] 既存システムとの切り替え
- [ ] 状態の同期
- [ ] エラーハンドリング

### Day 5-6: テスト
- [ ] SR Latchテスト
- [ ] オシレータテスト  
- [ ] パフォーマンステスト

### Day 7: 仕上げ
- [ ] UIでの動作確認
- [ ] ドキュメント更新
- [ ] デモ準備

## 💡 成功の鍵
1. **完璧を求めない** - 動くことが最優先
2. **段階的に改善** - まずSR Latchだけでも
3. **既存を壊さない** - 並行稼働で安全に

## 🎯 最終目標
**基本ゲートだけで、あらゆる順序回路が作れるLogiCirc**