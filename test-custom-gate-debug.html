<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Gate Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
        }
        h1 {
            color: #00ff88;
        }
        .test-case {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .issue {
            color: #ff6666;
            font-weight: bold;
        }
        .expected {
            color: #66ff66;
            margin-top: 10px;
        }
        .steps {
            margin-top: 15px;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background-color: #3a3a3a;
            border-radius: 4px;
        }
        .code {
            background-color: #444;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>🔧 カスタムゲート デバッグテスト</h1>
    
    <div class="test-case">
        <h2>🔍 問題1: 入力ピン数が常に2つになる</h2>
        <div class="issue">
            現象: 1入力のカスタムゲートを作成しても、表示される入力ピンが2つになっている
        </div>
        
        <h3>テスト手順</h3>
        <div class="steps">
            <div class="step">
                <strong>1.</strong> アプリを起動し、INPUTゲート1つとOUTPUTゲート1つを配置
            </div>
            <div class="step">
                <strong>2.</strong> INPUTとOUTPUTをワイヤーで接続
            </div>
            <div class="step">
                <strong>3.</strong> 「回路→IC」ボタンをクリック
            </div>
            <div class="step">
                <strong>4.</strong> ダイアログで：
                <div class="code">
ゲート名: Buffer
表示名: バッファ
説明: 入力をそのまま出力
アイコン: ⚡（デフォルトの🔧から変更）
入力ピン: A (デフォルトのA,Bから、Bを削除してAのみ)
出力ピン: Y (デフォルトのまま)
                </div>
            </div>
            <div class="step">
                <strong>5.</strong> 作成ボタンをクリック
            </div>
            <div class="step">
                <strong>6.</strong> 作成されたカスタムゲートをツールパレットからクリックして配置
            </div>
        </div>
        
        <div class="expected">
            期待結果: 配置されたカスタムゲートの入力ピンが1つだけ表示される
        </div>
        <div class="issue">
            実際の結果: 入力ピンが2つ表示される（問題）
        </div>
    </div>
    
    <div class="test-case">
        <h2>🔍 問題2: カスタムゲート出力が常にOFF</h2>
        <div class="issue">
            現象: カスタムゲートに入力を与えても、出力が常にOFF（灰色）のまま
        </div>
        
        <h3>テスト手順</h3>
        <div class="steps">
            <div class="step">
                <strong>1.</strong> 上記で作成したバッファゲートをキャンバスに配置
            </div>
            <div class="step">
                <strong>2.</strong> INPUTゲートを配置し、ON状態にする（ダブルクリック）
            </div>
            <div class="step">
                <strong>3.</strong> INPUTゲートとカスタムゲートの入力をワイヤーで接続
            </div>
            <div class="step">
                <strong>4.</strong> カスタムゲートの出力にOUTPUTゲートを接続
            </div>
        </div>
        
        <div class="expected">
            期待結果: 
            <ul>
                <li>INPUTがON → カスタムゲート出力が緑（ON）</li>
                <li>INPUTがOFF → カスタムゲート出力が灰色（OFF）</li>
                <li>OUTPUTゲートも同様に光る</li>
            </ul>
        </div>
        <div class="issue">
            実際の結果: カスタムゲートの出力ピンが常に灰色のまま（問題）
        </div>
    </div>
    
    <div class="test-case">
        <h2>✅ 修正確認: ダイアログリセット</h2>
        <div class="expected">
            期待結果: CreateCustomGateDialog.tsxのuseEffect修正により、ダイアログが閉じられた際に全ての状態がリセットされる
        </div>
        
        <h3>テスト手順</h3>
        <div class="steps">
            <div class="step">
                <strong>1.</strong> カスタムゲート作成ダイアログを開く
            </div>
            <div class="step">
                <strong>2.</strong> 適当な値を入力して「作成」ボタンをクリック
            </div>
            <div class="step">
                <strong>3.</strong> 再度ダイアログを開く
            </div>
            <div class="step">
                <strong>4.</strong> 全てのフィールドが空/デフォルト値になっていることを確認
            </div>
        </div>
    </div>
    
    <div class="test-case">
        <h2>🎯 デバッグポイント</h2>
        
        <h3>問題1の調査ポイント</h3>
        <div class="code">
Gate.tsx 549-584行目: カスタムゲート入力ピンレンダリング
- definition.inputs.mapでピンを描画
- 実際のdefinition.inputs.lengthが正しいかチェック

GateFactory.ts 79-90行目: createCustomGate関数  
- inputs: new Array(definition.inputs.length).fill('')
- 配列のサイズが正しいかチェック

ToolPalette.tsx 145-174行目: カスタムゲート配置処理
- GateFactory.createCustomGate呼び出し
- 定義が正しく渡されているかチェック
        </div>
        
        <h3>問題2の調査ポイント</h3>
        <div class="code">
simulation.ts 99-159行目: カスタムゲート評価ロジック
- internalCircuit内の回路評価
- outputMappingからの結果取得
- 最初の出力のみを返している（129-147行目）

Gate.tsx 599-621行目: カスタムゲート出力ピン表示
- gate.outputの値を使用
- evaluateCircuitでgate.outputが正しく設定されているかチェック
        </div>
    </div>
    
    <div class="test-case">
        <h2>🚀 次のステップ</h2>
        <div class="steps">
            <div class="step">
                <strong>1.</strong> コンソールログを追加してカスタムゲート作成時のdefinitionをチェック
            </div>
            <div class="step">
                <strong>2.</strong> Gate.tsxでレンダリング時のピン数をログ出力
            </div>
            <div class="step">
                <strong>3.</strong> simulation.tsでカスタムゲート評価時の詳細ログを追加
            </div>
            <div class="step">
                <strong>4.</strong> evaluateCircuit後のgate.outputの値をチェック
            </div>
        </div>
    </div>
</body>
</html>